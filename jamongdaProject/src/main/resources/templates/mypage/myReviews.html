<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/layout">
<head>
<meta charset="UTF-8">
<title>리뷰 페이지</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!--이미지 로드 관련 라이브러리-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
<style>
	html,
	body {
	    position: relative;
	    min-width: 1250px;
	    max-width: 1920px;
	    margin: 0 auto;
	}

	body {
	    background: rgb(252, 252, 252);
	    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
	    font-size: 14px;
	    color: #000;
	    margin: 0;
	    padding: 0;
	}

	.myReviews-container {
	    width: 40%;
	    margin: 50px auto;
	    padding: 20px;
	    background-color: #fff;
	    border-radius: 10px;
	    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
	}

	.header {
	    text-align: left;
	    margin-bottom: 20px;
	}

	.header h1 {
	    margin: 0;
	    font-size: 24px;
	    color: #333;
	}

	.header p {
	    margin: 5px 0 20px;
	    color: #777;
	}

	.review {
	    display: flex;
	    flex-direction: column;
	    padding: 20px;
	    border: 1px solid #ddd;
	    border-radius: 10px;
	    background-color: #fafafa;
	    margin-bottom: 20px;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.review h2 {
	    font-size: 20px;
	    margin-bottom: 10px;
	    color: #333;
	}

	.review p {
	    margin: 5px 0;
	    font-size: 14px;
	    color: #555;
	    word-wrap: break-word;
	    overflow-wrap: break-word;
	}

	.ro_name {
	    color: #777;
	    word-wrap: break-word;
	    overflow-wrap: break-word;
	}

	.review span {
	    font-weight: bold;
	}

	.review img {
	    max-width: 150px;
	    max-height: 150px;
	    border-radius: 5px;
	    margin-right: 15px;
	}

	.review a {
	    display: inline-block;
	    width: 100%;
	    padding: 10px 20px;
	    border: 1px solid #ddd;
	    border-radius: 5px;
	    background-color: #fafafa;
	    color: #1a73e8;
	    text-decoration: none;
	    font-size: 14px;
	    text-align: center;
	}

	.review a:hover {
	    background-color: #e1e1e1;
	}

	.load-more-btn {
	    display: block;
	    width: 100%;
	    padding: 10px;
	    border: none;
	    border-radius: 5px;
	    color: rgb(137, 137, 137);
	    font-size: 14px;
	    text-align: center;
	    cursor: pointer;
	    margin-top: 20px;
	}

	.load-more-btn:hover {
	    cursor: pointer;
	    color: rgb(114, 114, 114);
	}

	.image-gallery {
	    display: flex;
	    flex-wrap: wrap;
	    gap: 10px;
	    margin-top: 20px;
	    align-items: flex-start; /* 이미지 정렬 조정 */
	}

	.review-image {
	    width: 150px;
	    height: 150px;
	    object-fit: cover;
	    border-radius: 5px;
	}
	
	.rev_header {
		display: flex;
		justify-content: space-between;
	}
</style>
<script th:inline="javascript">
    /*<![CDATA[*/
    const email = /*[[${guest.email}]]*/ 'default@example.com';
    /*]]>*/
    console.log('이메일 :' + email);
</script>
<script>
	$(document).ready(function() {
	    let page = 1;
	    const pageSize = 10;

	    function loadReviews() {
	        console.log('Loading reviews for page:', page);
	        $.ajax({
	            url: '/mypage/getReviewsAjax',
	            method: 'POST',
	            data: { email: email, page: page, size: pageSize },
	            success: function(data) {
	                console.log('Data received:', data);
	                if (data && data.length > 0) {
	                    // 이미 렌더링된 리뷰의 ID 목록을 가져옵니다.
	                    let existingIds = $('#reviews .review').map(function() {
	                        return $(this).data('rev_id');
	                    }).get();
	                    
	                    // 새로운 리뷰만 추가합니다.
	                    let reviewsHtml = '';
	                    data.forEach(review => {
	                        if (!existingIds.includes(review.rev_id)) {
	                            reviewsHtml += `
	                                <div class="review" data-rev_id="${review.rev_id}">
	                                    <p class="rev_header">
	                                        <span>작성일자 : ${review.rev_date}</span>
	                                        <i class="fa-solid fa-trash-can delete-review" style="cursor: pointer;"></i>
	                                    </p>
	                                    <p><span class="acc_name">이용숙소 : ${review.acc_name}</span></p>
	                                    <p><span class="ro_name">이용객실 : ${review.ro_name}</span></p>
	                                    <p><span>${review.rev_content}</span></p>
	                                    <div class="image-gallery">
	                                        ${review.images.map(image => 
	                                            `<img src="/review/downloadImage?rev_image=${image.rev_image}" alt="Review Image" class="review-image"/>`
	                                        ).join('')}
	                                    </div>
	                                </div>
	                            `;
	                        }
	                    });

	                    $('#reviews').append(reviewsHtml);
	                    page++;
	                } else {
	                    $('#loadMore').hide();
	                }
	            },
	            error: function(jqXHR, textStatus, errorThrown) {
	                console.error('AJAX Error:', textStatus, errorThrown);
	                alert('리뷰를 로드하는 데 실패했습니다.');
	            }
	        });
	    }

	    loadReviews();

	    $('#loadMore').on('click', function() {
	        loadReviews();
	    });

	    $('#reviews').on('click', '.delete-review', function() {
	        let reviewElement = $(this).closest('.review');
	        let reviewId = reviewElement.data('rev_id');

	        if (confirm("리뷰를 삭제하시겠습니까?")) {
	            $.ajax({
	                url: '/review/deleteReviews',
	                method: 'POST',
	                data: { id: reviewId },
	                success: function(response) {
	                    console.log('Delete response:', response);
	                    reviewElement.remove();
	                    alert("리뷰를 삭제했습니다.");
	                },
	                error: function(jqXHR, textStatus, errorThrown) {
	                    console.error('AJAX Error:', textStatus, errorThrown);
	                    alert('리뷰를 삭제하는 데 실패했습니다.');
	                }
	            });
	        }
	    });
	});

</script>
</head>
<body>
    <th:block layout:fragment="content">
        <div class="myReviews-container">
            <div id="reviews">
                <!-- 리뷰 AJAX -->
            </div>
            <button id="loadMore" class="load-more-btn">▼더보기</button>
        </div>
    </th:block>
</body>
</html>
